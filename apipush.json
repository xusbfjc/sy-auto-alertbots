import PImage from "pureimage";

const TG_BOT_TOKEN = process.env.TG_BOT_TOKEN;
const TG_CHAT_ID = process.env.TG_CHAT_ID;

// === ç»˜åˆ¶ Binance é£æ ¼å¡ç‰‡ ===
async function drawCard(data) {
  const W = 800, H = 450;
  const img = PImage.make(W, H);
  const ctx = img.getContext("2d");

  // æ ·å¼é¢œè‰²
  const bg = "#1A1A1A";
  const binanceYellow = "#FCD535";
  const green = "#00D1B3";
  const red = "#FF4E4E";
  const pnlGreen = "#00FF99";
  const gray = "#888888";

  // èƒŒæ™¯
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, W, H);

  // æ ‡é¢˜ Binance
  ctx.fillStyle = binanceYellow;
  ctx.font = "32pt sans";
  ctx.fillText("Binance Futures", 40, 60);

  // æ–¹å‘ + æ æ† + å¸ç§
  const side = data.direction || "-";
  const lev = data.leverage ? ` | ${data.leverage}` : "";
  const sym = (data.symbol || "") + " æ°¸ç»­";
  ctx.fillStyle = side === "ç©º" ? red : green;
  ctx.font = "22pt sans";
  ctx.fillText(`${side}${lev} | ${sym}`, 40, 110);

  // æ”¶ç›Šç‡
  if (data.pnl_percent) {
    ctx.fillStyle = pnlGreen;
    ctx.font = "bold 56pt sans";
    ctx.fillText(data.pnl_percent, 40, 190);
  }

  // å¼€ä»“ä»· / æœ€æ–°ä»·
  ctx.fillStyle = binanceYellow;
  ctx.font = "20pt sans";
  if (data.entry_price) ctx.fillText(`å¼€ä»“ä»·æ ¼   ${data.entry_price}`, 40, 250);
  if (data.price) ctx.fillText(`æœ€æ–°ä»·æ ¼   ${data.price}`, 40, 290);

  // æ—¶é—´
  ctx.fillStyle = gray;
  ctx.font = "16pt sans";
  const ts = data.ts || new Date().toISOString();
  ctx.fillText(`${ts}`, 40, 330);

  // Footer
  ctx.fillStyle = gray;
  ctx.font = "16pt sans";
  const footer = "SY Auto Push";
  const w = ctx.measureText(footer).width;
  ctx.fillText(footer, W - w - 40, H - 40);

  // è¾“å‡º buffer
  return new Promise((resolve, reject) => {
    const chunks = [];
    const stream = {
      writable: true,
      write: buf => chunks.push(Buffer.from(buf)),
      end: () => resolve(Buffer.concat(chunks)),
      on: () => {},
      once: () => {}
    };
    PImage.encodePNGToStream(img, stream).catch(reject);
  });
}

// === Telegram æ¨é€ ===
export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(405).json({ error: "Use POST" });

  try {
    const data = req.body || {};
    const caption = `ğŸ“Š ${data.symbol || "æœªçŸ¥"}\næ–¹å‘: ${data.direction}\nå¼€ä»“ä»·: ${data.entry_price}\nç°ä»·: ${data.price}\næ”¶ç›Šç‡: ${data.pnl_percent}`;
    const buffer = await drawCard(data);

    const url = `https://api.telegram.org/bot${TG_BOT_TOKEN}/sendPhoto`;
    const form = new FormData();
    form.append("chat_id", TG_CHAT_ID);
    form.append("caption", caption);
    form.append("photo", new Blob([buffer], { type: "image/png" }), "card.png");

    const resp = await fetch(url, { method: "POST", body: form });
    const json = await resp.json();
    if (!json.ok) throw new Error(JSON.stringify(json));

    res.status(200).json({ ok: true, result: json.result });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
}
